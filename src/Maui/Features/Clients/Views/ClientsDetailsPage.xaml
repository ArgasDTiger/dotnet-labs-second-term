<?xml version="1.0" encoding="utf-8"?>

<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewModels="clr-namespace:Maui.Features.Clients.ViewModels"
             xmlns:models="clr-namespace:Maui.Features.Clients.Models"
             xmlns:converters="clr-namespace:Maui.Shared.Converters"
             x:DataType="viewModels:ClientDetailsViewModel"
             x:Class="Maui.Features.Clients.Views.ClientsDetailsPage"
             Title="Client Details">

    <ContentPage.Resources>
        <converters:IsNotNullOrEmptyConverter x:Key="IsNotNullOrEmpty" />
        <converters:IsNullConverter x:Key="IsNull" />

        <Style x:Key="BaseLabel" TargetType="Label">
            <Setter Property="TextColor" Value="{StaticResource Gray200}" />
            <Setter Property="FontSize" Value="14" />
        </Style>
        <Style x:Key="Header" TargetType="Label" BasedOn="{StaticResource BaseLabel}">
            <Setter Property="FontSize" Value="15" />
            <Setter Property="TextColor" Value="{StaticResource Gray100}" />
        </Style>

        <Style x:Key="HeaderValue" TargetType="Label" BasedOn="{StaticResource BaseLabel}">
            <Setter Property="FontSize" Value="15" />
            <Setter Property="TextColor" Value="{StaticResource Gray200}" />
        </Style>
        <!-- 3. Reference that key here too -->
        <Style x:Key="Title" TargetType="Label" BasedOn="{StaticResource BaseLabel}">
            <Setter Property="FontSize" Value="21" />
            <Setter Property="FontAttributes" Value="Bold" />
        </Style>
    </ContentPage.Resources>

    <ScrollView>
        <VerticalStackLayout Padding="10" Spacing="15">
            <Button Text="← Back to Clients"
                    Command="{Binding GoBackCommand}"
                    HorizontalOptions="Start" />

            <Border Stroke="{StaticResource Gray600}"
                    StrokeThickness="1"
                    Padding="15">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="5" />
                </Border.StrokeShape>

                <VerticalStackLayout Spacing="10">
                    <Label Style="{StaticResource Title}" HorizontalOptions="Center">
                        <Label.Text>
                            <MultiBinding StringFormat="{}{0} {1} {2}">
                                <Binding Path="Client.LastName" />
                                <Binding Path="Client.FirstName" />
                                <Binding Path="Client.MiddleName" />
                            </MultiBinding>
                        </Label.Text>
                    </Label>

                    <BoxView HeightRequest="1" Color="{StaticResource Gray600}" />

                    <Grid ColumnSpacing="10" RowSpacing="10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>

                        <Label Grid.Row="0" Grid.Column="0" Text="Phone Number:" Style="{StaticResource Header}" />
                        <Label Grid.Row="1" Grid.Column="0" Text="{Binding Client.PhoneNumber}"
                               Style="{StaticResource HeaderValue}" />
                        <Label Grid.Row="0" Grid.Column="1" Text="Home Address:" Style="{StaticResource Header}" />
                        <Label Grid.Row="1" Grid.Column="1" Text="{Binding Client.HomeAddress}"
                               Style="{StaticResource HeaderValue}" />

                        <Label Grid.Row="2" Grid.Column="0" Text="Passport Series:" Style="{StaticResource Header}"
                               IsVisible="{Binding Client.PassportSeries, Converter={StaticResource IsNotNullOrEmpty}}" />
                        <Label Grid.Row="3" Grid.Column="0" Text="{Binding Client.PassportSeries}"
                               IsVisible="{Binding Client.PassportSeries, Converter={StaticResource IsNotNullOrEmpty}}"
                               Style="{StaticResource HeaderValue}" />
                        <Label Grid.Row="2" Grid.Column="1" Text="Passport Number:" Style="{StaticResource Header}" />
                        <Label Grid.Row="3" Grid.Column="1" Text="{Binding Client.PassportNumber}"
                               Style="{StaticResource HeaderValue}" />
                    </Grid>
                </VerticalStackLayout>
            </Border>

            <Label Text="Rented Movies" FontSize="20" FontAttributes="Bold" TextColor="{StaticResource White}" />

            <CollectionView ItemsSource="{Binding Client.RentedMovies}">

                <!-- Message when list is empty -->
                <CollectionView.EmptyView>
                    <Grid Padding="20">
                        <Label Text="This client has no rented movies."
                               TextColor="{StaticResource Gray400}"
                               HorizontalOptions="Center" />
                    </Grid>
                </CollectionView.EmptyView>

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:ClientMovie">
                        <Border Stroke="{StaticResource Gray600}"
                                StrokeThickness="1"
                                Padding="15"
                                Margin="0,5">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="5" />
                            </Border.StrokeShape>

                            <VerticalStackLayout Spacing="10">
                                <Label Text="{Binding MovieTitle}" Style="{StaticResource Title}" />

                                <Grid ColumnSpacing="10" RowSpacing="5">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>

                                    <Label Grid.Row="0" Grid.Column="0" Text="Expected return date:"
                                           Style="{StaticResource Header}" />
                                    <Label Grid.Row="1" Grid.Column="0"
                                           Text="{Binding ExpectedReturnDate, StringFormat='{0:yyyy-MM-dd}'}"
                                           Style="{StaticResource HeaderValue}" />

                                    <Label Grid.Row="0" Grid.Column="1" Text="Price Per Day:"
                                           Style="{StaticResource Header}" />
                                    <Label Grid.Row="1" Grid.Column="1"
                                           Text="{Binding PricePerDay, StringFormat='{0:C}'}"
                                           Style="{StaticResource HeaderValue}" />

                                    <Label Grid.Row="2" Grid.Column="0" Text="Returned On:"
                                           Style="{StaticResource Header}"
                                           IsVisible="{Binding ReturnedDate, Converter={StaticResource IsNotNullOrEmpty}}" />
                                    <Label Grid.Row="2" Grid.Column="0"
                                           Text="{Binding ReturnedDate, StringFormat='{0:yyyy-MM-dd}'}"
                                           IsVisible="{Binding ReturnedDate, Converter={StaticResource IsNotNullOrEmpty}}"
                                           Style="{StaticResource HeaderValue}" />
                                </Grid>
                                <Button Text="Return"
                                        BackgroundColor="{StaticResource Primary}"
                                        HorizontalOptions="Start"
                                        CommandParameter="{Binding .}"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewModels:ClientDetailsViewModel}}, Path=ReturnMovieCommand}"
                                        IsVisible="{Binding ReturnedDate, Converter={StaticResource IsNull}}" />
                            </VerticalStackLayout>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

        </VerticalStackLayout>
    </ScrollView>

</ContentPage>